#!/usr/bin/env python3
import os
import logging
import json
import random
from typing import List, Dict, Tuple, Optional
from datetime import datetime
from enum import Enum
from dataclasses import dataclass, asdict
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

load_dotenv()


@dataclass
class TulInfo:
    """Информация о тулях"""
    name: str
    korean_name: str
    belt: str
    movements: int
    meaning: str
    history: str
    diagram: str = ""
    keywords: List[str] = None

    def __post_init__(self):
        if self.keywords is None:
            self.keywords = []


class TaekwondoKnowledgeSystem:
    """Система знаний по тхэквондо с полной информацией о Тулях"""

    def __init__(self, data_dir: str = "taekwondo_data"):
        self.data_dir = data_dir
        os.makedirs(data_dir, exist_ok=True)

        # Инициализация всех данных
        self.tuls = self._load_tuls()
        self.belts = self._load_belts_system()
        self.techniques = self._load_techniques()
        self.exams = self._load_exams()
        self.knowledge_base = self._create_complete_knowledge_base()

        # История диалогов
        self.conversation_history = {}

        # Проверяем целостность данных
        self._validate_data()

    def _validate_data(self):
        """Проверка целостности данных"""
        issues = []

        # Проверка тулей
        for tul in self.tuls:
            if not tul.name or not tul.belt:
                issues.append(f"Туль без имени или пояса: {tul}")

        # Проверка поясов
        for belt_key, belt_info in self.belts.items():
            for tul_name in belt_info.get("tuls", []):
                if not self.get_tul_by_name(tul_name):
                    issues.append(f"Пояс {belt_key} ссылается на несуществующий туль: {tul_name}")

        if issues:
            logger.warning(f"Обнаружены проблемы в данных: {len(issues)} issues")
            for issue in issues[:5]:  # Показываем только первые 5 проблем
                logger.warning(f"  - {issue}")

        return len(issues) == 0

    def _load_tuls(self) -> List[TulInfo]:
        """Загрузка полной информации о тулях"""
        tuls_data = [
            # 10 гып
            TulInfo(
                name="Саджу-Чаруги",
                korean_name="사주 지르기",
                belt="10 гып (белый пояс)",
                movements=4,
                meaning="Подготовительное упражнение - удар в четыре направления",
                history="Базовое упражнение для отработки прямых ударов руками в четыре основные стороны. Помогает развивать координацию и чувство направления.",
                diagram="Прямой крест (+), движения в четыре стороны: вперед, назад, влево, вправо",
                keywords=["саджу", "чариги", "подготовительное", "4 направления", "базовое"]
            ),
            TulInfo(
                name="Саджу-Макки",
                korean_name="사주 막기",
                belt="9 гып (белый с желтой полоской)",
                movements=4,
                meaning="Подготовительное упражнение - блок в четыре направления",
                history="Базовое упражнение для отработки защитных техник блокирования в четыре основные стороны.",
                diagram="Прямой крест (+), блоки в четыре стороны",
                keywords=["саджу", "макки", "блок", "защита", "4 направления"]
            ),

            # 9 гып
            TulInfo(
                name="Чон-Джи",
                korean_name="천지",
                belt="9 гып (белый с желтой полоской)",
                movements=19,
                meaning="Небо и Земля",
                history="Первый туль. Символизирует две основные стихии создания природы. Состоит из двух схожих частей: одна символизирует небо, другая - землю.",
                diagram="Форма буквы 'I' (ㅣ), вертикальное движение",
                keywords=["чон-джи", "первый туль", "небо земля", "19 движений", "основа"]
            ),

            # 8 гып
            TulInfo(
                name="Дан-Гун",
                korean_name="단군",
                belt="8 гып (желтый пояс)",
                movements=21,
                meaning="Основатель Кореи",
                history="Назван в честь легендарного основателя Кореи Дан-Гуна, жившего в 2333 году до нашей эры. Считается потомком небесного владыки и основателем первого корейского государства Кочосон.",
                diagram="Форма буквы 'I' (ㅣ)",
                keywords=["дан-гун", "основатель кореи", "2333 до н.э.", "21 движение", "желтый пояс"]
            ),

            # 7 гып
            TulInfo(
                name="До-Сан",
                korean_name="도산",
                belt="7 гып (желтый с зеленой полоской)",
                movements=24,
                meaning="Псевдоним патриота",
                history="Назван в честь патриота Ан Чхан Хо (1876-1938), использовавшего псевдоним 'До-Сан'. Он посвятил свою жизнь просвещению корейского народа и борьбе за независимость Кореи от японской оккупации.",
                diagram="Гора и солнце (символизирует восход над горой)",
                keywords=["до-сан", "ан чхан хо", "патриот", "24 движения", "просвещение"]
            ),

            # 6 гып
            TulInfo(
                name="Вон-Хьё",
                korean_name="원효",
                belt="6 гып (зеленый пояс)",
                movements=28,
                meaning="Буддийский монах",
                history="Назван в честь монаха Вон-Хьё (617-686), который представил буддизм династии Силла в 686 году. Известен синтезом буддизма с корейскими традициями.",
                diagram="Буддийский символ (свастика ман)",
                keywords=["вон-хьё", "монах", "буддизм", "28 движений", "династия силла"]
            ),

            # 5 гып
            TulInfo(
                name="Юль-Гок",
                korean_name="율곡",
                belt="5 гып (зеленый с синей полоска)",
                movements=38,
                meaning="Корейский Конфуций",
                history="Назван в честь философа и ученого И И (1536-1584), известного под псевдонимом 'Юль-Гок'. 38 движений символизируют 38-ю параллель, где он родился. Прозван 'Конфуцием Кореи'.",
                diagram="Иероглиф 'ученый' (士)",
                keywords=["юль-гок", "и и", "философ", "38 движений", "конфуцианец"]
            ),

            # 4 гып
            TulInfo(
                name="Джун-Гун",
                korean_name="중궁",
                belt="4 гып (синий пояс)",
                movements=32,
                meaning="Патриот-мученик",
                history="Назван в память о патриоте Ан Джун-Гуне (1879-1910), который убил японского генерал-губернатора Кореи Ито Хиробуми. 32 движений символизируют возраст, в котором его казнили в тюрьме Люйшунь.",
                diagram="Тюремная решетка (символизирует заключение)",
                keywords=["джун-гун", "ан джун-гун", "патриот", "32 движения", "казнь"]
            ),

            # 3 гып
            TulInfo(
                name="Тэ-Гэ",
                korean_name="퇴계",
                belt="3 гып (синий с красной полоской)",
                movements=37,
                meaning="Ученый-неоконфуцианец",
                history="Назван в честь ученого Ли Хвана (1501-1570), известного под псевдонимом 'Тэё-Гэ'. 37 движений символизируют 37-ю параллель, место его рождения. Известный мастер неоконфуцианства.",
                diagram="Иероглиф 'горы и вода' (山水)",
                keywords=["тэ-гэ", "ли хван", "ученый", "37 движений", "неоконфуцианство", "Тэ-ге"]
            ),

            # 2 гып
            TulInfo(
                name="Хва-Ранг",
                korean_name="화랑",
                belt="2 гып (красный пояс)",
                movements=29,
                meaning="Цветочная молодежь",
                history="Назван в честь общества молодых аристократов 'Хваран' ('Цветочные рыцари'), основанного в 576 году при династии Силла. Общество стало движущей силой объединения трех корейских королевств. 29 движений символизируют 29-ю пехотную дивизию, где было создано тхэквондо.",
                diagram="Цветок (символизирует молодежь)",
                keywords=["хва-ранг", "цветочные рыцари", "29 движений", "объединение", "диаграмма цветка"]
            ),

            # 1 гып
            TulInfo(
                name="Чунг-Му",
                korean_name="충무",
                belt="1 гып (красный с черной полоской)",
                movements=30,
                meaning="Верный воин",
                history="Назван в честь адмирала Ли Сун Сина (1545-1598) династии Чосон, создателя первых броненосных кораблей 'кобуксон'. Туль заканчивается ударом левой руки, символизируя трагическую гибель адмирала, не успевшего доказать свою лояльность королю.",
                diagram="Броненосный корабль (кобуксон)",
                keywords=["чунг-му", "ли сун син", "адмирал", "30 движений", "кобуксон"]
            ),

            # 1 дан
            TulInfo(
                name="Кван-Ге",
                korean_name="광개",
                belt="1 дан (черный пояс)",
                movements=39,
                meaning="Расширитель территории",
                history="Назван в честь 19-го короля Когурё Квангэтхо Великого (374-413), вернувшего утраченные территории. 39 движений символизируют первые две цифры года 391, когда он взошел на трон.",
                diagram="Расширяющаяся территория",
                keywords=["кван-ге", "квангэтхо", "39 движений", "расширение", "король когурё"]
            ),
            TulInfo(
                name="По-Ун",
                korean_name="포은",
                belt="1 дан (черный пояс)",
                movements=36,
                meaning="Верный ученый",
                history="Назван в честь поэта Чон Мон Джу (1337-1392), известного под псевдонимом 'По-Ун'. Его стих 'Я не буду служить второму господину, даже если меня казнят сто раз' стал символом верности.",
                diagram="Стойка верности",
                keywords=["по-ун", "чон мон джу", "поэт", "36 движений", "верность"]
            ),
            TulInfo(
                name="Ге-Бек",
                korean_name="계백",
                belt="1 дан (черный пояс)",
                movements=44,
                meaning="Строгий командир",
                history="Назван в честь генерала Кэбэка - Baekje Dynasty (660 г. н.э.) династии Пэкче, известного строгой военной дисциплиной. Погиб в битве при Хвансане, сражаясь до последнего солдата.",
                diagram="Строгие линии (военная дисциплина)",
                keywords=["ге-бек", "кэбэк", "генерал", "44 движения", "дисциплина"]
            ),
            # 2 дан
            TulInfo(
                name="Ый-Ам",
                korean_name="의암",
                belt="2 дан (черный пояс)",
                movements=45,
                meaning="Патриот-мыслитель",
                history="Назван в честь лидера движения за независимость Кореи Сон Бён Хи (1861-1922), использовавшего псевдоним 'Ый-Ам'. 45 движений символизируют его возраст в 1905 году.",
                diagram="Символ независимости",
                keywords=["ый-ам", "сон бён хи", "45 движений", "независимость", "движение 1 марта"]
            ),
            TulInfo(
                name="Джу-Джанг",
                korean_name="충장",
                belt="2 дан (черный пояс)",
                movements=52,
                meaning="Верный генерал",
                history="Назван в честь генерала Ким Джон Со (?-1388) династии Корё. Туль заканчивается ударом левой руки, символизируя его трагическую смерть в тюрьме в возрасте 27 лет.",
                diagram="Трагический финал",
                keywords=["джу-джанг", "ким джон со", "52 движения", "генерал", "трагедия"]
            ),

            TulInfo(
                name="Джу-Че",
                korean_name="주체",
                belt="2 дан (черный пояс)",
                movements=45,
                meaning="Хозяин своей судьбы",
                history="Назван в честь философской идеи 'чучхе' (опора на собственные силы). Символизирует гору Пэктусан, считающуюся духовной колыбелью корейского народа.",
                diagram="Гора Пэктусан",
                keywords=["джу-че", "самостоятельность", "45 движений", "пэктусан", "философия"]
            ),

            # 3 дан
            TulInfo(
                name="Сам-Ил",
                korean_name="삼일",
                belt="3 дан (черный пояс)",
                movements=33,
                meaning="Первое марта",
                history="Назван в честь Движения первого марта 1919 года за независимость Кореи. 33 движения символизируют 33 патриота, подписавших Декларацию независимости.",
                diagram="Дата 1 марта",
                keywords=["сам-ил", "1 марта", "33 движения", "независимость", "1919"]
            ),
            TulInfo(
                name="Ю-Син",
                korean_name="유신",
                belt="3 дан (черный пояс)",
                movements=68,
                meaning="Верный генерал",
                history="Назван в честь генерала Ким Ю Сина (595-673) династии Силла. 68 движений символизируют последние цифры 668 года - объединение Кореи. Начинается с позиции с мечом в правой руке, символизируя его ошибку следовать чужим войскам.",
                diagram="Меч в правой руке",
                keywords=["ю-син", "ким ю син", "68 движений", "объединение", "генерал"]
            ),
            TulInfo(
                name="Чой-Ёнг",
                korean_name="최영",
                belt="3 дан (черный пояс)",
                movements=46,
                meaning="Патриот-гуманист",
                history="Назван в честь генерала Чхве Ёна (1316-1388) династии Корё. Известен верностью, патриотизмом и гуманизмом. Казнен своими подчиненными по приказу Ли Сон Ге.",
                diagram="Символ верности и трагедии",
                keywords=["чой-ёнг", "чхве ён", "46 движений", "верность", "трагедия"]
            ),

            # 4 дан
            TulInfo(
                name="Йог-Ге",
                korean_name="영개",
                belt="4 дан (черный пояс)",
                movements=49,
                meaning="Победитель",
                history="Назван в честь генерала Йог Ге Сомун (?-665) династии Когурё. 49 движений символизируют последние цифры 649 года, когда он разбил войска династии Тан.",
                diagram="Победоносное сражение",
                keywords=["йог-ге", "йог ге сомун", "49 движений", "победа", "династия тан"]
            ),
            TulInfo(
                name="Уль-Чжи",
                korean_name="을지",
                belt="4 дан (черный пояс)",
                movements=42,
                meaning="Гений стратегии",
                history="Назван в честь генерала Ыльчи Мундока (?-?), успешно защитившего Когурё от миллионной армии династии Тан. 42 движения символизируют возраст основателя тхэквондо, когда он создал этот туль.",
                diagram="Гениальная стратегия",
                keywords=["уль-чжи", "ыльчи мундок", "42 движения", "стратегия", "оборона"]
            ),
            TulInfo(
                name="Мун-Му",
                korean_name="문무",
                belt="4 дан (черный пояс)",
                movements=61,
                meaning="Король-защитник",
                history="Назван в честь 30-го короля Силлы Мунму Великого (626-681). 61 движение символизируют 661 год - начало его правления. По его завещанию, тело похоронили в море, чтобы душа защищала Корею от японцев.",
                diagram="Защита с моря",
                keywords=["мун-му", "король мунму", "61 движение", "защитник", "море"]
            ),
            # 5 дан
            TulInfo(
                name="Со-Сан",
                korean_name="서산",
                belt="5 дан (черный пояс)",
                movements=72,
                meaning="Воинствующий монах",
                history="Назван в честь монаха Сосана (1520-1604), организовавшего отряды монахов-воинов. 72 движения символизируют его возраст при создании отрядов. Отряды успешно боролись с японскими пираты.",
                diagram="Монах-воин",
                keywords=["со-сан", "монах", "72 движения", "воины-монахи", "защита"]
            ),
            TulInfo(
                name="Се-Чжонг",
                korean_name="세종",
                belt="5 дан (черный пояс)",
                movements=24,
                meaning="Король-создатель",
                history="Назван в честь короля Сечжона Великого (1397-1450), создавшего корейский алфавит хангыль в 1443 году. 24 движения символизируют 24 буквы алфавита.",
                diagram="Корейский алфавит",
                keywords=["се-чжонг", "сечжон великий", "24 движения", "хангыль", "алфавит"]
            ),
            # 6 дан
            TulInfo(
                name="Тонг-Ил",
                korean_name="통일",
                belt="6 дан (черный пояс)",
                movements=56,
                meaning="Объединение",
                history="Символизирует объединение Кореи, разделенной в 1945 году. Выражает надежду на воссоединение северной и южной частей Кореи.",
                diagram="Единая Корея",
                keywords=["тонг-ил", "объединение", "56 движений", "единая корея", "воссоединение"]
            )
        ]

        return tuls_data

    def _load_belts_system(self) -> Dict:
        """Загрузка системы поясов"""
        belts = {
            "10_gup": {
                "name": "10 гып",
                "color": "Белый пояс",
                "description": "Чисто белый, символизирует чистоту и невинность ученика",
                "tuls": ["Саджу-Чаруги"],
                "duration": "1-2 месяца",
                "requirements": "Базовые стойки, удары, блоки, этикет"
            },
            "9_gup": {
                "name": "9 гып",
                "color": "Белый с желтой полоской",
                "description": "Начало обучения, символизирует первые шаги",
                "tuls": ["Чон-Джи", "Саджу-Макки"],
                "duration": "2-3 месяца",
                "requirements": "Основные техники, первый туль"
            },
            "8_gup": {
                "name": "8 гып",
                "color": "Желтый пояс",
                "description": "Желтый - цвет земли, где укореняются знания",
                "tuls": ["Дан-Гун"],
                "duration": "3-4 месяца",
                "requirements": "Улучшение техники, спарринг"
            },
            "7_gup": {
                "name": "7 гып",
                "color": "Желтый с зеленой полоской",
                "description": "Переходный этап, подготовка к зеленому поясу",
                "tuls": ["До-Сан"],
                "duration": "3-4 месяца",
                "requirements": "Комбинации, усложнение техник"
            },
            "6_gup": {
                "name": "6 гып",
                "color": "Зеленый пояс",
                "description": "Зеленый - цвет роста и развития",
                "tuls": ["Вон-Хьё"],
                "duration": "4-6 месяцев",
                "requirements": "Скорость, точность, сложные комбинации"
            },
            "5_gup": {
                "name": "5 гып",
                "color": "Зеленый с синей полоской",
                "description": "Приближение к синему поясу, развитие мастерства",
                "tuls": ["Юль-Гок"],
                "duration": "4-6 месяцев",
                "requirements": "Сила, выносливость, тактика"
            },
            "4_gup": {
                "name": "4 гып",
                "color": "Синий пояс",
                "description": "Синий - цвет неба, к которому стремится ученик",
                "tuls": ["Джун-Гун"],
                "duration": "6-8 месяцев",
                "requirements": "Сложные техники, тактические навыки"
            },
            "3_gup": {
                "name": "3 гып",
                "color": "Синий с красной полоской",
                "description": "Переход к красному поясу, совершенствование",
                "tuls": ["Тэ-Гэ"],
                "duration": "6-8 месяцев",
                "requirements": "Мастерство, контроль, преподавание основ"
            },
            "2_gup": {
                "name": "2 гып",
                "color": "Красный пояс",
                "description": "Красный - цвет опасности, предупреждение о силе",
                "tuls": ["Хва-Ранг"],
                "duration": "8-12 месяцев",
                "requirements": "Высокое мастерство, преподавание"
            },
            "1_gup": {
                "name": "1 гып",
                "color": "Красный с черной полоской",
                "description": "Последний ученический пояс, переход к мастерству",
                "tuls": ["Чунг-Му"],
                "duration": "8-12 месяцев",
                "requirements": "Полное владение техникой, подготовка к черному поясу"
            },
            "1_dan": {
                "name": "1 дан",
                "color": "Черный пояс",
                "description": "Помощник инструктора (Boo-sabum)",
                "tuls": ["Кван-Ге", "По-Ун", "Ге-Бек"],
                "duration": "1-2 года",
                "requirements": "Преподавание, руководство, постоянное совершенствование"
            },
            "2_dan": {
                "name": "2 дан",
                "color": "Черный пояс",
                "description": "Инструктор (Sabum)",
                "tuls": ["Ый-Ам", "Джу-Джанг", "Джу-Че"],
                "duration": "2 года",
                "requirements": "Углубленное преподавание, судейство"
            },
            "3_dan": {
                "name": "3 дан",
                "color": "Черный пояс",
                "description": "Инструктор (Sabum)",
                "tuls": ["Сам-Ил", "Ю-Син", "Чой-Ёнг"],
                "duration": "3 года",
                "requirements": "Высокое мастерство, подготовка инструкторов"
            },
            "4_dan": {
                "name": "4 дан",
                "color": "Черный пояс",
                "description": "Мастер (Sahyun)",
                "tuls": ["Йог-Ге", "Уль-Чжи", "Мун-Му"],
                "duration": "4 года",
                "requirements": "Высшее мастерство, развитие тхэквондо"
            },
            "5_dan": {
                "name": "5 дан",
                "color": "Черный пояс",
                "description": "Мастер (Sahyun)",
                "tuls": ["Со-Сан", "Се-Чжонг"],
                "duration": "5 лет",
                "requirements": "Вклад в развитие, международное признание"
            },
            "6_dan": {
                "name": "6 дан",
                "color": "Черный пояс",
                "description": "Великий мастер (Saseong)",
                "tuls": ["Тонг-Ил"],
                "duration": "6 лет",
                "requirements": "Выдающийся вклад, наследие"
            }
        }

        return belts

    def _load_techniques(self) -> Dict:
        """Загрузка техник и терминов"""
        techniques = {
            "Стойки в тхэквондо": {
                "Нарани соги": "Параллельная стойка, ноги на ширине плеч",
                "Чарёт соги": "Стойка «смирно».",
                "ГОННУН СОГИ": "длина стойки полторы ширины плеч, ширина стойки – ширина плеч. Сзади стоящая нога прямая, впереди стоящая нога согнута в коленном суставе, так чтобы проекция о колена падала за пятку впереди стоящей ноги. Вес тела 55 на 45 процентов.",
                "Аннун соги": "Cтойка в тхэквондо ИТФ, также называется стойкой «всадника». Название связано с тем, что поза напоминает форма ног человека во время езды на лошади.",
                "Ап соги": "Передняя высокая стойка, в которой одна нога выставлена вперёд, как при обычной ходьбе, а обе ноги выпрямлены.",
                "Двиткуби соги": "L-образная стойка, одна нога согнута, другая прямая",
                "НЬЮНТЬСЯ СОГИ": "длина стойки полторы ширины плеч, ширина стойки 2-3 сантиметра, стопы перпендикулярны друг другу, вес тела 70 % на задней ноге, 30 % на передней",
                "СУДЖИК СОГИ": "длина стойки ширина плеч, стопы перпендикулярны друг другу"
            },
            "Счет": {
                "ХАНА": "раз",
                "ДУЛЬ": "два",
                "СЭТ": "три",
                "НЭТ": "четыре",
                "ДАСЭТ": "пять",
                "ЁСЕТ": "шесть",
                "ЕЛЬГОП": "семь",
                "ЭДОЛЬП": "восемь",
                "АХОП": "девять",
                "ЫЛЬ(ЁЛЬ)": "десять"
            },
            "Удары ногами": {
                "Ап чаги": "Прямой удар ногой вперед",
                "АП ЧАУЛИГИ": "Мах вверх прямой ногой",
                "ДОЛЬЕ ЧАГИ": "удар ногой с боку",
                "ЮП ЧАГИ": "боковой удар ногой",
                "ЮП ЧАУЛИГИ": "боковой мах",
                "НЭРЬЕ ЧАГИ": "удар ногой сверху вниз",
                "ДВИТ ЧАГИ": "удар спиной вперед",
                "ДВИТ ЧАУЛИГИ": "мах назад",
                "ПАНДЭЙ ДОЛЬЕ ЧАГИ": "круговой удар ногой"
            },
            "Удары рукой": {
                "Джумок": "Прямой удар кулаком",
                "Чируги": "Удар кончиками пальцев",
                "Йоп чируги": "Боковой удар рукой",
                "Пьён чумок": "Удар кулаком сбоку"
            },
            "Блоки руками": {
                "Аре макки": "Нижний блок",
                "Ольгуль макки": "Верхний блок",
                "Хэчжо макки": "Двойной блок",
                "Момтом макки": "Блок туловища"
            },
            "Терминалогия Тхэквондо": {
                "ЧАРЬЁТ": "смирно (внимание)",
                "ДЖУМБИ": "приготовиться",
                "СИДЖАК": "приступить к выполнению",
                "БАРО": "вернуться в исходное положение",
                "НАСИ": "вернуться в предыдущую позицию",
                "БАРКИТЭ": "сменить фронтальность, стойку",
                "СЁ": "вольно",
                "ТИРО ТОРАТ": "поворот на 180 градусов в движении",
                "СОМРО": "бесконтактный спарринг",
                "ДОДЯНГ": "зал, ковёр для занятий по ТКД",
                "ДОБОК": "костюм для тренировок по ТКД",
                "ТИ": "пояс",
                "ХОНГ": "красный",
                "ЧОНГ": "синий",
                "ХЭЧЁ": "остановка боя",
                "ТОЛЬЁН": "набивка ударных поверхностей",
                "АНДЖО": "сесть",
                "НАГАГИ": "движение вперед",
                "ТЭРГАГИ": "движение назад",
                "ТВИМИО": "прыжок"
            },
            "Дисциплины на соревнованиях": {
                "Туль": "Комплекс из основных атакующих и защитных движений, которые выполняются в логически обоснованной последовательности. Занимающийся имитирует поединок с несколькими соперниками, выполняя различные атакующие и защитные действия, соответствующие «складывающейся обстановке».",
                "Массоги": "Спарринг, поединок, возможность применить на практике умения и навыки, приобретённые при изучении базовой техники. Часть соревнований по тхэквондо ИТФ. На крупных чемпионатах программа соревнований включает индивидуальное и командное первенство, в обычном формате — только индивидуальное первенство.",
                "Силовое разбивание (power breaking)": "Спортсмены разбивают доски стандартного размера (30×30×1,5 см), которые расположены на специальном станке. Задача — разбить как можно больше досок за 1 удар. После успешной попытки количество досок увеличивается.",
                "Самооборона": "защитить себя в случае нападения или опасной ситуации, противостоять одному или множеству противников одновременно, в том числе вооружённым.",
                "Специальная техника": "Специальная техника - это особенная техника, в которой необходимо выполнять в прыжке удары различной сложности на определённой высоте или в длину и высоту."
            }
        }

        return techniques

    def _load_exams(self) -> Dict:
        """Загрузка информации об экзаменах"""
        exams = {
            "10 гып": {
                "Туль": "Саджу Чируги",
                "Техника ударов ногами (ЧАГИ)": "Удары ногами - Ап чаги, Бакуро нэрио. Ануро нэрио",
                "Спарринг (МАССОГИ)": "САМБО Массоги А (без партнёра)",
                "Теоретическая часть": "1. Этикет тхэквондо 2. Правила поведения в спорт.зале. 3. Счёт на корейском."
            },
            "9 гып": {
                "Туль": "Саджу Чируги, Саджу-Макги, Чон-Джи",
                "Техника ударов ногами (ЧАГИ)": "Удары ногами Ап чаги Бакуро нэрио чаги, Ануро нэрио чаги, Двит, Твимио ап чаги. Повторы Ап ап, Нерио нерио",
                "Спарринг (МАССОГИ)": "САМБО Массоги А (без партнёра)",
                "Теоретическая часть": "1. Этикет тхэквондо 2. Правила поведения в спорт.зале. 3. Заповеди тхэквондиста 4. Стойки: чарьёт, нарани, гоннун"
            },
            "8 гып": {
                "Туль": "Саджу-Макки, Чон-Джи, Дангун",
                "Техника ударов ногами (ЧАГИ)": "Удары ногами - Долье чаги, Твимио ап чаги. Повторы Нерио ап Ап нерио, Двит Ап. Связки Ап нерио, Ап двит",
                "Спарринг (МАССОГИ)": "САМБО Массоги В (с партнёром) 3 варианта: Чуке макки, Каунде макки, Надзинде макки",
                "Теоретическая часть": "1. Этикет тхэквондо 2. Правила поведения в спорт.зале. 3. Заповеди тхэквондиста 4. Стойки: чарьёт, нарани, гоннун, ньюнться. 5. Цвета поясов."
            },
            "7 гып": {
                "Туль": "Чон-Джи, Дан-гун, До-Сан",
                "Техника ударов ногами (ЧАГИ)": "Удары ногами - Двит чаги, Твимио, долье чаги. Повторы - Долио – Долио, Ап-Долио. Связки Ап-Долио, Долио – Нэрио, Долио – двит",
                "Спарринг (МАССОГИ)": "САМБО Массоги В (с партнёром) 3 варианта: Чуке макки, Каунде макки, Надзинде макки",
                "Теоретическая часть": "1. Этикет тхэквондо 2. Правила поведения в спорт.зале. 3. Заповеди тхэквондиста 4. Стойки: чарьёт, нарани, гоннун, ньюнться"
            },
            "6 гып": {
                "Туль": "Дан-гун, До-Сан, Вон-Хьё",
                "Техника ударов ногами (ЧАГИ)": "Удары ногами - Юпча чируги, Торо нэрио чаги, Твимио двит чаги. Повторы - Ап-Нэрио, Ап-Долио, Долио нэрио. Связки - Долио-Ап, Нэрио-Долио, Нэрио-Двит",
                "Спарринг (МАССОГИ)": "САМБО Массоги (с партнёром) 3 варианта: Чуке макки, Каунде макки, Надзинде макки",
                "Теоретическая часть": "1. Этикет тхэквондо 2. Правила поведения в спорт.зале. 3. Заповеди тхэквондиста; 4. Стойки: двитбал, моа, губурё, кёча."
            },
            "5 гып": {
                "Туль": "До-Сан, Вон-Хьё, Юль-Гок",
                "Техника ударов ногами (ЧАГИ)": "Удары ногами - Твимио юпча чируги, Твимио торо нэрио чаги. Повторы - Долио-ап чаги, Долио-юпча чируги, Долио-нэрио чаги. Связки - Юп чаги-долио, Юп чаги-твид, двит-долио",
                "Спарринг (МАССОГИ)": "Ибо Массоги 5 вариантов",
                "Теоретическая часть": "1. Этикет тхэквондо 2. Правила поведения в спорт.зале. 3. Заповеди тхэквондиста; 4. Стойки: двитбал, моа, губурё, кёча. 5. Секреты мастерства"
            },
            "4 гып": {
                "Туль": "Вон-Хьё, Юль-Гок, Джун-Гун",
                "Техника ударов ногами (ЧАГИ)": "Удары ногами - Горо чаги, Твимио двит 360, Пандэ долье чаги. Повторы - Юпча чируги-долио, Юпча чируги-юпча, чируги двит-долио. Связки - Твимио ап чаги-нерио чаги, Твимио долио-долио чаги, твимио юпча чируги-ап чаги",
                "Спецтехника (ТЭК ГИ)": "Твимио нопи чаги – высота удара измеряется по запястью поднятой руки",
                "Спарринг (МАССОГИ)": "Ибо Массоги 10 вариантов",
                "Теоретическая часть": "1. Этикет тхэквондо 2. Правила поведения в спорт.зале. 3. Заповеди тхэквондиста; 4. Стойки: двитбал, моа, губурё, кёча, суджик, выбал. 5. Секреты мастерства 6. Принципы силы."
            },
            "3 гып": {
                "Туль": "Юль-Гок, Джун-Гун, Тэ-Гэ",
                "Техника ударов ногами (ЧАГИ)": "Удары ногами - Твимио пандэ, долио чаги, Твимио горо чаги. Повторы - Юп чаги-долио-ап чаги, Долио-ап чаги-горо, Юп чаги-горо-долио. Связки - Долио-панде долио, Юп чаги-панде долио, Пандэ долио-долио",
                "Спецтехника (ТЭК ГИ)": "Твимио нопи чаги – высота удара измеряется по запястью поднятой руки",
                "Спарринг (МАССОГИ)": "Ибо Массоги 10 вариантов (на один шаг с партнёром)",
                "Теоретическая часть": "1. Этикет тхэквондо 2. Правила поведения в спорт.зале. 3. Заповеди тхэквондиста; 4. Стойки: двитбал, моа, губурё, кёча, суджик, выбал. 5. Секреты мастерства 6. Принципы силы."
            },
            "2 гып": {
                "Туль": "Джун-Гун, Тэ-Гэ, Хва-Ранг",
                "Техника ударов ногами (ЧАГИ)": "Удары ногами - Панде горо чаги, Твимио-нери 360. Повторы - Нерио-ап чаги-долио, Юп чаги-нэрио-ап чаги, Долио-нэрио юп чаги. Связки - Долио-твимио двит, Твимио юп чаги-твимо двит, Твимио пандэ долио-долио",
                "Спецтехника (ТЭК ГИ)": "Долио чаги – высота измеряется по ладошке поднятой руки.",
                "Спарринг (МАССОГИ)": "Самбо, ибо, ильбо массоги. Свободный спарринг",
                "Теоретическая часть": "1. История тхэквондо 2. Принципы тхэквондо 3. Названия движений в тулях 4. Правила судейства тулей 5. Правила судейства в спарринге"
            },
            "1 гып": {
                "Туль": "Тэ-Гэ, Хва-Ранг, Чунг-Му",
                "Техника ударов ногами (ЧАГИ)": "Удары ногами - Твимио Панде горо чаги, Твимио долио 360. Повторы - Твимио Два ап чаги, Твимио повтор долио. Связки - Три удара по выбору",
                "Спецтехника (ТЭК ГИ)": "Пандэ долио чаги - высота измеряется по ладошке поднятой руки",
                "Спарринг (МАССОГИ)": "Самбо, ибо, ильбо массоги, Свободный спарринг, Защита от оружия",
                "Теоретическая часть": "1. История тхэквондо 2. Принципы тхэквондо 3. Названия движений в тулях 4. Правила судейства тулей 5. Правила судейства в спарринге"
            },
            "1 дан": {
                "Туль": "Хва-Ранг, Чунг-Му, Кван-Ге, По-Ун, Ге-Бек",
                "Техника ударов ногами (ЧАГИ)": "Удары ногами - Любой удар из ранее изученного материала. Повторы - Любой удар из ранее изученного материала. Связки - Комбинация из нескольких ударов.",
                "Спецтехника (ТЭК ГИ)": "Твимио нопи чаги, Твимио долио чаги, Твимио пандэ долио чаги Номо чаги",
                "Спарринг (МАССОГИ)": "Самбо, ибо, ильбо массоги, Свободный спарринг, Защита от оружия",
                "Теоретическая часть": "1. История тхэквондо 2. Принципы тхэквондо 3. Названия движений в тулях 4. Правила судейства тулей 5. Правила судейства в спарринге"
            }
        }

        return exams

    def _create_complete_knowledge_base(self) -> Dict:
        """Создание полной базы знаний"""
        knowledge = {
            "tuls": {tul.name: asdict(tul) for tul in self.tuls},
            "belts": self.belts,
            "techniques": self.techniques,
            "exams": self.exams,
            "statistics": {
                "total_tuls": len(self.tuls),
                "total_movements": sum(tul.movements for tul in self.tuls),
                "belt_levels": len(self.belts),
                "technique_categories": len(self.techniques)
            }
        }

        # Сохраняем базу знаний
        knowledge_file = os.path.join(self.data_dir, "complete_knowledge.json")
        try:
            with open(knowledge_file, 'w', encoding='utf-8') as f:
                json.dump(knowledge, f, ensure_ascii=False, indent=2)
            logger.info(f"База знаний сохранена: {knowledge_file}")
        except Exception as e:
            logger.error(f"Ошибка сохранения базы знаний: {e}")

        return knowledge

    def get_tul_by_name(self, name: str) -> Optional[Dict]:
        """Получить информацию о туле по имени"""
        for tul in self.tuls:
            if tul.name.lower() == name.lower():
                return asdict(tul)
        return None

    def get_tuls_by_belt(self, belt: str) -> List[Dict]:
        """Получить все тули для определенного пояса"""
        return [asdict(tul) for tul in self.tuls if tul.belt.lower() == belt.lower()]

    def get_belt_info(self, belt_key: str) -> Optional[Dict]:
        """Получить информацию о поясе"""
        return self.belts.get(belt_key)

    def get_exam_info(self, belt_name: str) -> Optional[Dict]:
        """Получить информацию об экзамене на пояс"""
        return self.exams.get(belt_name)

    def search_tuls(self, keyword: str) -> List[Dict]:
        """Поиск тулей по ключевому слову"""
        results = []
        keyword_lower = keyword.lower()

        for tul in self.tuls:
            # Проверяем в названии
            if keyword_lower in tul.name.lower():
                results.append(asdict(tul))
                continue

            # Проверяем в корейском названии
            if keyword_lower in tul.korean_name.lower():
                results.append(asdict(tul))
                continue

            # Проверяем в значении
            if keyword_lower in tul.meaning.lower():
                results.append(asdict(tul))
                continue

            # Проверяем в истории
            if keyword_lower in tul.history.lower():
                results.append(asdict(tul))
                continue

            # Проверяем в ключевых словах
            if any(keyword_lower in kw.lower() for kw in tul.keywords):
                results.append(asdict(tul))
                continue

        return results

    def get_tul_progression(self) -> List[Dict]:
        """Получить прогрессию тулей по поясам"""
        progression = []

        for belt_key, belt_info in self.belts.items():
            belt_tuls = []
            for tul_name in belt_info.get("tuls", []):
                tul = self.get_tul_by_name(tul_name)
                if tul:
                    belt_tuls.append({
                        "name": tul["name"],
                        "movements": tul["movements"],
                        "meaning": tul["meaning"]
                    })

            progression.append({
                "belt": belt_info["name"],
                "color": belt_info["color"],
                "tuls": belt_tuls,
                "duration": belt_info.get("duration", "")
            })

        return progression

    def get_random_tul_fact(self) -> str:
        """Получить случайный факт о туле"""
        if not self.tuls:
            return "В базе данных нет информации о тулях."

        tul = random.choice(self.tuls)

        facts = [
            f"Туль '{tul.name}' ({tul.korean_name}) состоит из {tul.movements} движений.",
            f"Туль '{tul.name}' изучается на уровне {tul.belt}.",
            f"Значение туля '{tul.name}': {tul.meaning}.",
            f"Историческая справка: {tul.history[:250]}...",
            f"Туль '{tul.name}' символизирует: {tul.meaning}."
        ]

        return random.choice(facts)

    def get_belt_timeline(self) -> List[Dict]:
        """Получить временную шкалу поясов"""
        timeline = []

        belt_order = [
            "10_gup", "9_gup", "8_gup", "7_gup", "6_gup", "5_gup",
            "4_gup", "3_gup", "2_gup", "1_gup", "1_dan", "2_dan",
            "3_dan", "4_dan", "5_dan", "6_dan"
        ]

        for i, belt_key in enumerate(belt_order):
            if belt_key in self.belts:
                belt_info = self.belts[belt_key]
                timeline.append({
                    "order": i + 1,
                    "belt": belt_info["name"],
                    "color": belt_info["color"],
                    "description": belt_info["description"],
                    "tuls_count": len(belt_info.get("tuls", []))
                })

        return timeline

    def find_belt_by_query(self, query: str) -> Optional[Tuple[str, Dict]]:
        """Найти пояс по текстовому запросу"""
        query_lower = query.lower().strip()

        # Карта синонимов и вариантов написания
        belt_variants_map = {
            # Гыпы
            "10 гып": ["10 гып", "10гып", "10-гып", "10-ый гып", "десятый гып", "10 гуп", "10гуп", "10"],
            "9 гып": ["9 гып", "9гып", "9-гып", "9-ый гып", "девятый гып", "9 гуп", "9гуп", "9"],
            "8 гып": ["8 гып", "8гып", "8-гып", "8-ый гып", "восьмой гып", "8 гуп", "8гуп", "8"],
            "7 гып": ["7 гып", "7гып", "7-гып", "7-ый гып", "седьмой гып", "7 гуп", "7гуп", "7"],
            "6 гып": ["6 гып", "6гып", "6-гып", "6-ой гып", "шестой гып", "6 гуп", "6гуп", "6"],
            "5 гып": ["5 гып", "5гып", "5-гып", "5-ый гып", "пятый гып", "5 гуп", "5гуп", "5"],
            "4 гып": ["4 гып", "4гып", "4-гып", "4-ый гып", "четвертый гып", "4 гуп", "4гуп", "4"],
            "3 гып": ["3 гып", "3гып", "3-гып", "3-ий гып", "третий гып", "3 гуп", "3гуп", "3"],
            "2 гып": ["2 гып", "2гып", "2-гып", "2-ой гып", "второй гып", "2 гуп", "2гуп", "2"],
            "1 гып": ["1 гып", "1гып", "1-гып", "1-ый гып", "первый гып", "1 гуп", "1гуп", "1"],

            # Цвета поясов
            "белый пояс": ["белый пояс", "белый", "white belt", "white"],
            "белый с желтой": ["белый с желтой", "белый желтый", "белый-желтый", "бело-желтый", "бело желтый"],
            "желтый пояс": ["желтый пояс", "желтый", "yellow belt", "yellow"],
            "желтый с зеленой": ["желтый с зеленой", "желтый зеленый", "желто-зеленый", "желто зеленый"],
            "зеленый пояс": ["зеленый пояс", "зеленый", "green belt", "green"],
            "зеленый с синей": ["зеленый с синей", "зеленый синий", "зелено-синий", "зелено синий"],
            "синий пояс": ["синий пояс", "синий", "blue belt", "blue"],
            "синий с красной": ["синий с красной", "синий красный", "сине-красный", "сине красный"],
            "красный пояс": ["красный пояс", "красный", "red belt", "red"],
            "красный с черной": ["красный с черной", "красный черный", "красно-черный", "красно черный"],

            # Даны (черные пояса)
            "1 дан": ["1 дан", "1-дан", "первый дан", "черный пояс 1 дан", "1st dan", "1st", "первый черный",
                      "черный 1"],
            "2 дан": ["2 дан", "2-дан", "второй дан", "черный пояс 2 дан", "2nd dan", "2nd", "второй черный",
                      "черный 2"],
            "3 дан": ["3 дан", "3-дан", "третий дан", "черный пояс 3 дан", "3rd dan", "3rd", "третий черный",
                      "черный 3"],
            "4 дан": ["4 дан", "4-дан", "четвертый дан", "черный пояс 4 дан", "4th dan", "четвертый черный",
                      "черный 4"],
            "5 дан": ["5 дан", "5-дан", "пятый дан", "черный пояс 5 дан", "5th dan", "пятый черный", "черный 5"],
            "6 дан": ["6 дан", "6-дан", "шестой дан", "черный пояс 6 дан", "6th dan", "шестой черный", "черный 6"],
            "черный пояс": ["черный пояс", "черный", "black belt", "black", "черный"]
        }

        # Сначала ищем точное совпадение в вариантах
        for belt_key in self.belts.keys():
            belt_info = self.belts[belt_key]

            # Проверяем точное совпадение имени
            if query_lower == belt_info["name"].lower():
                return belt_key, belt_info

            # Проверяем точное совпадение цвета
            if query_lower == belt_info["color"].lower():
                return belt_key, belt_info

            # Проверяем частичное совпадение в имени
            if belt_info["name"].lower() in query_lower:
                return belt_key, belt_info

            # Проверяем частичное совпадение в цвете
            if belt_info["color"].lower() in query_lower:
                return belt_key, belt_info

        # Затем ищем по синонимам
        for belt_key, belt_info in self.belts.items():
            belt_name = belt_info["name"]
            belt_color = belt_info["color"]

            # Проверяем варианты написания для этого пояса
            if belt_name in belt_variants_map:
                for variant in belt_variants_map[belt_name]:
                    if variant.lower() == query_lower or variant.lower() in query_lower:
                        return belt_key, belt_info

            # Проверяем варианты написания для цвета
            if belt_color in belt_variants_map:
                for variant in belt_variants_map[belt_color]:
                    if variant.lower() == query_lower or variant.lower() in query_lower:
                        return belt_key, belt_info

        # Ищем по общим синонимам для черного пояса
        if "черный" in query_lower or "black" in query_lower or "дан" in query_lower:
            # Возвращаем первый дан как основной черный пояс
            return "1_dan", self.belts["1_dan"]

        return None


class TaekwondoTulBot:
    """Бот с полной информацией о тулях тхэквондо"""

    def __init__(self):
        self.TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
        if not self.TOKEN:
            raise ValueError("TELEGRAM_BOT_TOKEN не найден")

        self.knowledge = TaekwondoKnowledgeSystem()
        self.user_data = {}

        # Маппинг для кнопок тулей (короткое название -> полное название)
        self.belt_short_to_full = {
            "10_гып": "10 гып (белый пояс)",
            "9_гып": "9 гып (белый с желтой полоской)",
            "8_гып": "8 гып (желтый пояс)",
            "7_гып": "7 гып (желтый с зеленой полоской)",
            "6_гып": "6 гып (зеленый пояс)",
            "5_гып": "5 гып (зеленый с синей полоска)",
            "4_гып": "4 гып (синий пояс)",
            "3_гып": "3 гып (синий с красной полоской)",
            "2_гып": "2 гып (красный пояс)",
            "1_гып": "1 гып (красный с черной полоской)",
            "1_дан": "1 дан (черный пояс)",
            "2_дан": "2 дан (черный пояс)",
            "3_дан": "3 дан (черный пояс)",
            "4_дан": "4 дан (черный пояс)",
            "5_дан": "5 дан (черный пояс)",
            "6_дан": "6 дан (черный пояс)"
        }

        # Маппинг для обратного поиска (полное название -> короткое)
        self.belt_full_to_short = {v: k for k, v in self.belt_short_to_full.items()}

    def get_main_menu(self) -> InlineKeyboardMarkup:
        """Главное меню"""
        keyboard = [
            [
                InlineKeyboardButton("🌀 Все тули", callback_data='all_tuls'),
                InlineKeyboardButton("🎽 Пояса", callback_data='belts_system')
            ],
            [
                InlineKeyboardButton("🔍 Поиск туля", callback_data='search_tul'),
                InlineKeyboardButton("📚 Техники", callback_data='techniques')
            ],
            [
                InlineKeyboardButton("📋 Экзамен", callback_data='exams'),
                InlineKeyboardButton("🆘 Помощь", callback_data='help')
            ]
        ]
        return InlineKeyboardMarkup(keyboard)

    def get_tuls_menu(self) -> InlineKeyboardMarkup:
        """Меню тулей"""
        keyboard = []

        # Группируем тули по поясам
        belt_groups = {}
        for tul in self.knowledge.tuls:
            belt = tul.belt
            if belt not in belt_groups:
                belt_groups[belt] = []
            belt_groups[belt].append(tul.name)

        # Создаем кнопки для каждой группы
        for belt, tuls in belt_groups.items():
            # Находим короткое название для callback_data
            belt_short = None
            for short, full in self.belt_short_to_full.items():
                if full == belt:
                    belt_short = short
                    break

            # Если не нашли точное совпадение, используем начало строки
            if not belt_short:
                belt_short = belt.split("(")[0].strip().replace(' ', '_')

            # Создаем красивый текст для кнопки
            if "дан" in belt:
                emoji = "🥋"
                display_name = belt_short.replace('_', ' ')
            else:
                emoji = "🎽"
                display_name = belt_short.replace('_', ' ')

            keyboard.append([InlineKeyboardButton(f"{emoji} {display_name}", callback_data=f'belt_{belt_short}')])

        keyboard.append([InlineKeyboardButton("⬅️ Назад", callback_data='back_to_menu')])
        return InlineKeyboardMarkup(keyboard)

    def get_belts_menu(self) -> InlineKeyboardMarkup:
        """Меню поясов"""
        keyboard = []

        # Группируем пояса на две колонки
        belts_order = [
            ("10 гып", "10_gup"),
            ("9 гып", "9_gup"),
            ("8 гып", "8_gup"),
            ("7 гып", "7_gup"),
            ("6 гып", "6_gup"),
            ("5 гып", "5_gup"),
            ("4 гып", "4_gup"),
            ("3 гып", "3_gup"),
            ("2 гып", "2_gup"),
            ("1 гып", "1_gup"),
            ("1 дан", "1_dan"),
            ("2 дан", "2_dan"),
            ("3 дан", "3_dan"),
            ("4 дан", "4_dan"),
            ("5 дан", "5_dan"),
            ("6 дан", "6_dan")
        ]

        # Создаем кнопки в две колонки
        for i in range(0, len(belts_order), 2):
            row = []
            if i < len(belts_order):
                name, key = belts_order[i]
                row.append(InlineKeyboardButton(f"🎽 {name}", callback_data=f'belt_info_{key}'))
            if i + 1 < len(belts_order):
                name, key = belts_order[i + 1]
                row.append(InlineKeyboardButton(f"🎽 {name}", callback_data=f'belt_info_{key}'))
            if row:
                keyboard.append(row)

        keyboard.append([InlineKeyboardButton("⬅️ Назад", callback_data='back_to_menu')])
        return InlineKeyboardMarkup(keyboard)

    def get_techniques_menu(self) -> InlineKeyboardMarkup:
        """Меню техник"""
        techniques = self.knowledge.techniques
        keyboard = []

        # Создаем кнопки для каждой категории техник
        for category in techniques.keys():
            keyboard.append([InlineKeyboardButton(f"🥊 {category}", callback_data=f'technique_{category}')])

        keyboard.append([InlineKeyboardButton("⬅️ Назад", callback_data='back_to_menu')])
        return InlineKeyboardMarkup(keyboard)

    def get_exams_menu(self) -> InlineKeyboardMarkup:
        """Меню экзаменов"""
        keyboard = []

        # Создаем кнопки для каждого пояса
        belts_order = [
            "10 гып", "9 гып", "8 гып", "7 гып", "6 гып",
            "5 гып", "4 гып", "3 гып", "2 гып", "1 гып",
            "1 дан"
        ]

        # Создаем кнопки в две колонки
        for i in range(0, len(belts_order), 2):
            row = []
            if i < len(belts_order):
                belt_name = belts_order[i]
                row.append(InlineKeyboardButton(f"📋 {belt_name}", callback_data=f'exam_{belt_name}'))
            if i + 1 < len(belts_order):
                belt_name = belts_order[i + 1]
                row.append(InlineKeyboardButton(f"📋 {belt_name}", callback_data=f'exam_{belt_name}'))
            if row:
                keyboard.append(row)

        keyboard.append([InlineKeyboardButton("⬅️ Назад", callback_data='back_to_menu')])
        return InlineKeyboardMarkup(keyboard)

    def get_back_menu(self) -> InlineKeyboardMarkup:
        """Кнопка Назад"""
        keyboard = [[InlineKeyboardButton("⬅️ Назад", callback_data='back_to_menu')]]
        return InlineKeyboardMarkup(keyboard)

    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Команда /start"""
        user = update.effective_user

        stats = self.knowledge.knowledge_base["statistics"]

        welcome_text = f"""
🥋 <b>Добро пожаловать в энциклопедию тхэквондо ИТФ!</b>

Здесь собрана полная информация о системе тулей и поясов тхэквондо.

<u><b>База знаний содержит:</b></u>
• {stats['total_tuls']} тулей
• {stats['total_movements']} движений
• {stats['belt_levels']} уровней поясов
• {stats['technique_categories']} категорий техник

<u><b>Доступные функции:</b></u>
🌀 <b>Все тули</b> - полный список формальных комплексов
🎽 <b>Пояса</b> - система градации и требования
🔍 <b>Поиск тулей</b> - найти тул по названию или ключевому слову
📚 <b>Техники</b> - удары, стойки, блоки, термины
📋 <b>Экзамен</b> - требования для сдачи на пояса

<u><b>Примеры запросов:</b></u>
• "Чон-Джи"
• "желтый пояс"
• "5 гып"
• "1 дан" или "черный пояс"
• "Хва-Ранг"
• "Сколько движений в До-Сане?"

Выберите раздел в меню или напишите название туля или пояса!
        """

        await update.message.reply_text(
            welcome_text,
            reply_markup=self.get_main_menu(),
            parse_mode='HTML'
        )

    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Обработка текстовых сообщений"""
        query = update.message.text.strip()

        if not query:
            await update.message.reply_text(
                "Пожалуйста, введите название туля или ключевое слово для поиска.",
                reply_markup=self.get_main_menu()
            )
            return

        # Показываем индикатор "печатает"
        await context.bot.send_chat_action(
            chat_id=update.effective_chat.id,
            action='typing'
        )

        try:
            # 1. Сначала пробуем найти тул по точному названию
            tul = self.knowledge.get_tul_by_name(query)
            if tul:
                await self._send_tul_info(update, tul)
                return

            # 2. Поиск по поясам через улучшенную функцию
            belt_match = self.knowledge.find_belt_by_query(query)
            if belt_match:
                belt_key, belt_info = belt_match
                await self._send_belt_info(update, belt_key, belt_info)
                return

            # 3. Поиск тулей по ключевым словам
            results = self.knowledge.search_tuls(query)
            if results:
                if len(results) == 1:
                    await self._send_tul_info(update, results[0])
                else:
                    await self._send_search_results(update, results, query)
                return

            # 4. Если ничего не нашли
            await update.message.reply_text(
                f"❌ Не удалось найти информацию по запросу: '{query}'\n\n"
                "<b>Попробуйте:</b>\n"
                "• Написать точное название туля\n"
                "• Указать цвет или номер пояса (например: 'желтый пояс', '5 гып')\n"
                "• Для черных поясов: '1 дан', 'черный пояс', 'black belt'\n"
                "• Использовать меню для навигации\n\n"
                "<b>Или используйте команды:</b>\n"
                "/tuls - Все тули\n"
                "/belts - Система поясов\n"
                "/exams - Экзамены\n"
                "/techniques - Техники",
                reply_markup=self.get_main_menu(),
                parse_mode='HTML'
            )

        except Exception as e:
            logger.error(f"Ошибка в handle_message: {e}", exc_info=True)
            await update.message.reply_text(
                "❌ Произошла ошибка при поиске. Попробуйте еще раз.",
                reply_markup=self.get_main_menu()
            )

    async def _send_tul_info(self, update, tul: Dict):
        """Отправить информацию о туле"""
        response = f"""
🌀 <b>{tul['name']}</b> <i>({tul['korean_name']})</i>

<b>Уровень:</b> {tul['belt']}
<b>Количество движений:</b> {tul['movements']}
<b>Значение:</b> {tul['meaning']}

<b>Историческая справка:</b>
{tul['history']}

<b>Диаграмма:</b> {tul['diagram']}
        """

        await update.message.reply_text(
            response,
            reply_markup=self.get_back_menu(),
            parse_mode='HTML'
        )

    async def _send_search_results(self, update, results: List[Dict], query: str):
        """Отправить результаты поиска"""
        total_results = len(results)
        if total_results > 10:
            display_results = results[:10]
            extra_text = f"\n\n<i>Показано 10 из {total_results} результатов. Уточните запрос для более точного поиска.</i>"
        else:
            display_results = results
            extra_text = ""

        response = f"""
🔍 <b>Результаты поиска по запросу: "{query}"</b>

Найдено {total_results} тулей:
        """

        for i, tul in enumerate(display_results, 1):
            response += f"\n{i}. <b>{tul['name']}</b> - {tul['belt']} ({tul['movements']} движений)"

        response += f"\n\n<i>Напишите точное название туля для получения подробной информации.</i>{extra_text}"

        await update.message.reply_text(
            response,
            reply_markup=self.get_back_menu(),
            parse_mode='HTML'
        )

    async def _send_belt_info(self, update, belt_key: str, belt_info: Dict):
        """Отправить информацию о поясе"""
        # Получаем тули для этого пояса
        tuls_info = []
        for tul_name in belt_info.get("tuls", []):
            tul = self.knowledge.get_tul_by_name(tul_name)
            if tul:
                tuls_info.append(f"• <b>{tul['name']}</b> ({tul['movements']} движений) - {tul['meaning']}")

        # Формируем ответ
        response = f"""
🎽 <b>{belt_info['name']} - {belt_info['color']}</b>

<b>Описание:</b> {belt_info['description']}
<b>Продолжительность обучения:</b> {belt_info.get('duration', 'Не указано')}

<b>Требования:</b> {belt_info.get('requirements', 'Не указаны')}

<b>Тули для этого уровня:</b>
{chr(10).join(tuls_info) if tuls_info else '• Нет тулей для этого уровня'}
        """

        # Добавляем кнопки для перехода к тулям этого пояса
        keyboard = []
        if tuls_info:
            # Находим короткое название пояса для callback_data
            short_name = None
            for short, full in self.belt_short_to_full.items():
                if belt_info["name"] == short.replace('_', ' '):
                    short_name = short
                    break

            if short_name:
                keyboard.append([InlineKeyboardButton(f"🌀 Показать тули {belt_info['name']}",
                                                      callback_data=f'belt_{short_name}')])

        keyboard.append([InlineKeyboardButton("⬅️ Назад", callback_data='back_to_menu')])

        await update.message.reply_text(
            response,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='HTML'
        )

    async def _send_exam_info(self, update, belt_name: str):
        """Отправить информацию об экзамене"""
        exam_info = self.knowledge.get_exam_info(belt_name)

        if not exam_info:
            await update.message.reply_text(
                f"Информация об экзамене на пояс '{belt_name}' не найдена.",
                reply_markup=self.get_back_menu()
            )
            return

        response = f"""
📋 <b>Экзамен на {belt_name}</b>

<b>Туль:</b> {exam_info.get('Туль', 'Не указано')}

<b>Техника ударов ногами (ЧАГИ):</b>
{exam_info.get('Техника ударов ногами (ЧАГИ)', 'Не указано')}
        """

        if 'Спецтехника (ТЭК ГИ)' in exam_info:
            response += f"\n<b>Спецтехника (ТЭК ГИ):</b>\n{exam_info['Спецтехника (ТЭК ГИ)']}"

        response += f"\n<b>Спарринг (МАССОГИ):</b>\n{exam_info.get('Спарринг (МАССОГИ)', 'Не указано')}"
        response += f"\n\n<b>Теоретическая часть:</b>\n{exam_info.get('Теоретическая часть', 'Не указано')}"

        await update.message.reply_text(
            response,
            reply_markup=self.get_back_menu(),
            parse_mode='HTML'
        )

    async def handle_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Обработка callback-запросов"""
        query = update.callback_query
        await query.answer()

        data = query.data

        try:
            if data == 'back_to_menu':
                await self._show_main_menu(query)

            elif data == 'all_tuls':
                await self._show_all_tuls(query)

            elif data == 'belts_system':
                await self._show_belts_system(query)

            elif data == 'search_tul':
                await query.edit_message_text(
                    "🔍 <b>Поиск туля</b>\n\n"
                    "Напишите название туля или ключевое слово для поиска.\n\n"
                    "Примеры:\n"
                    "• Чон-Джи\n"
                    "• 24 движения\n"
                    "• Красный пояс\n"
                    "• Корейское название\n",
                    reply_markup=self.get_back_menu(),
                    parse_mode='HTML'
                )

            elif data == 'techniques':
                await self._show_techniques_menu(query)

            elif data == 'exams':
                await self._show_exams_menu(query)

            elif data == 'help':
                await self._show_help(query)

            elif data.startswith('belt_') and not data.startswith('belt_info_'):
                # Показать тули для конкретного пояса (без info)
                belt_query = data.replace('belt_', '')
                await self._show_tuls_for_belt(query, belt_query)

            elif data.startswith('belt_info_'):
                # Показать информацию о поясе (из меню "Система поясов")
                belt_key = data.replace('belt_info_', '')
                await self._show_belt_info_from_menu(query, belt_key)

            elif data.startswith('technique_'):
                # Показать технику
                technique_category = data.replace('technique_', '')
                await self._show_technique_category(query, technique_category)

            elif data.startswith('exam_'):
                # Показать информацию об экзамене
                belt_name = data.replace('exam_', '')
                await self._show_exam_info_from_menu(query, belt_name)

        except Exception as e:
            logger.error(f"Ошибка обработки callback: {e}", exc_info=True)
            await query.edit_message_text(
                f"❌ Произошла ошибка при обработке запроса: {str(e)[:100]}\n\nПопробуйте еще раз.",
                reply_markup=self.get_main_menu()
            )

    async def _show_main_menu(self, query):
        """Показать главное меню"""
        await query.edit_message_text(
            "🥋 <b>Энциклопедия тхэквондо ИТФ</b>\n\n"
            "Выберите раздел:",
            reply_markup=self.get_main_menu(),
            parse_mode='HTML'
        )

    async def _show_all_tuls(self, query):
        """Показать все тули"""
        await query.edit_message_text(
            "🌀 <b>Все тули тхэквондо ИТФ</b>\n\n"
            "Выберите уровень пояса для просмотра тулей:",
            reply_markup=self.get_tuls_menu(),
            parse_mode='HTML'
        )

    async def _show_tuls_for_belt(self, query, belt_query: str):
        """Показать тули для определенного пояса"""
        # Ищем полное название пояса в маппинге
        full_belt = self.belt_short_to_full.get(belt_query)

        # Если не нашли в маппинге, ищем похожий пояс
        if not full_belt:
            for tul in self.knowledge.tuls:
                if belt_query.replace('_', ' ').lower() in tul.belt.lower():
                    full_belt = tul.belt
                    break

        if not full_belt:
            await query.edit_message_text(
                f"Пояс '{belt_query}' не найден.",
                reply_markup=self.get_back_menu()
            )
            return

        tuls = self.knowledge.get_tuls_by_belt(full_belt)

        if not tuls:
            await query.edit_message_text(
                f"Для пояса '{full_belt}' не найдено тулей.",
                reply_markup=self.get_back_menu()
            )
            return

        response = f"🌀 <b>Тули для уровня: {full_belt}</b>\n\n"

        for i, tul in enumerate(tuls, 1):
            response += f"<b>{i}. {tul['name']}</b> ({tul['korean_name']})\n"
            response += f"   • Движений: {tul['movements']}\n"
            response += f"   • Значение: {tul['meaning']}\n\n"

        response += "<i>Напишите точное название туля для подробной информации.</i>"

        await query.edit_message_text(
            response,
            reply_markup=self.get_back_menu(),
            parse_mode='HTML'
        )

    async def _show_belts_system(self, query):
        """Показать систему поясов"""
        await query.edit_message_text(
            "🎽 <b>Система поясов тхэквондо ИТФ</b>\n\n"
            "10 ученических степеней (гыпов) и 9 мастерских (данов).\n\n"
            "Выберите уровень:",
            reply_markup=self.get_belts_menu(),
            parse_mode='HTML'
        )

    async def _show_belt_info_from_menu(self, query, belt_key: str):
        """Показать информацию о поясе из меню поясов"""
        # Удаляем префикс 'belt_info_' если он есть
        if belt_key.startswith('belt_info_'):
            belt_key = belt_key.replace('belt_info_', '')

        belt_info = self.knowledge.get_belt_info(belt_key)

        if not belt_info:
            await query.edit_message_text(
                f"Информация о поясе '{belt_key}' не найдена.",
                reply_markup=self.get_back_menu()
            )
            return

        # Получаем тули для этого пояса
        tuls_info = []
        for tul_name in belt_info.get("tuls", []):
            tul = self.knowledge.get_tul_by_name(tul_name)
            if tul:
                tuls_info.append(f"• <b>{tul['name']}</b> - {tul['movements']} движений\n  <i>{tul['meaning']}</i>")

        response = f"""
🎽 <b>{belt_info['name']} - {belt_info['color']}</b>

<b>Описание:</b> {belt_info['description']}
<b>Продолжительность обучения:</b> {belt_info.get('duration', 'Не указано')}

<b>Требования:</b> {belt_info.get('requirements', 'Не указаны')}

<b>Тули для этого уровня:</b>
{chr(10).join(tuls_info) if tuls_info else '• Нет тулей для этого уровня'}
        """

        # Добавляем кнопку для просмотра тулей
        keyboard = []
        if tuls_info:
            # Находим короткое название для callback_data
            short_name = None
            for short, full in self.belt_short_to_full.items():
                if belt_info["name"] == short.replace('_', ' '):
                    short_name = short
                    break

            if short_name:
                keyboard.append([InlineKeyboardButton(f"🌀 Показать тули {belt_info['name']}",
                                                      callback_data=f'belt_{short_name}')])

        keyboard.append([InlineKeyboardButton("⬅️ Назад", callback_data='back_to_menu')])

        await query.edit_message_text(
            response,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='HTML'
        )

    async def _show_techniques_menu(self, query):
        """Показать меню техник"""
        await query.edit_message_text(
            "📚 <b>Техники тхэквондо ИТФ</b>\n\n"
            "Выберите категорию техник:",
            reply_markup=self.get_techniques_menu(),
            parse_mode='HTML'
        )

    async def _show_technique_category(self, query, category: str):
        """Показать техники определенной категории"""
        techniques = self.knowledge.techniques
        if category not in techniques:
            await query.edit_message_text(
                f"Категория '{category}' не найдена.",
                reply_markup=self.get_back_menu()
            )
            return

        category_techniques = techniques[category]

        response = f"🥊 <b>{category}</b>\n\n"

        for name, description in category_techniques.items():
            response += f"<b>{name}</b>\n{description}\n\n"

        await query.edit_message_text(
            response,
            reply_markup=self.get_back_menu(),
            parse_mode='HTML'
        )

    async def _show_exams_menu(self, query):
        """Показать меню экзаменов"""
        await query.edit_message_text(
            "📋 <b>Экзамены на пояса</b>\n\n"
            "Выберите пояс для просмотра требований к экзамену:",
            reply_markup=self.get_exams_menu(),
            parse_mode='HTML'
        )

    async def _show_exam_info_from_menu(self, query, belt_name: str):
        """Показать информацию об экзамене из меню"""
        exam_info = self.knowledge.get_exam_info(belt_name)

        if not exam_info:
            await query.edit_message_text(
                f"Информация об экзамене на пояс '{belt_name}' не найдена.",
                reply_markup=self.get_back_menu()
            )
            return

        response = f"""
📋 <b>Экзамен на {belt_name}</b>

<b>Туль:</b> {exam_info.get('Туль', 'Не указано')}

<b>Техника ударов ногами (ЧАГИ):</b>
{exam_info.get('Техника ударов ногами (ЧАГИ)', 'Не указано')}
        """

        if 'Спецтехника (ТЭК ГИ)' in exam_info:
            response += f"\n<b>Спецтехника (ТЭК ГИ):</b>\n{exam_info['Спецтехника (ТЭК ГИ)']}"

        response += f"\n<b>Спарринг (МАССОГИ):</b>\n{exam_info.get('Спарринг (МАССОГИ)', 'Не указано')}"
        response += f"\n\n<b>Теоретическая часть:</b>\n{exam_info.get('Теоретическая часть', 'Не указано')}"

        await query.edit_message_text(
            response,
            reply_markup=self.get_back_menu(),
            parse_mode='HTML'
        )

    async def _show_help(self, query):
        """Показать справку"""
        help_text = """
🆘 <b>Справка по использованию бота</b>

<u>Основные функции:</u>
• <b>Все тули</b> - полный список тулей по уровням поясов
• <b>Пояса</b> - информация о системе поясов
• <b>Поиск тулей</b> - найти туль по названию или ключевому слову
• <b>Техники</b> - удары, стойки, блоки, термины
• <b>Экзамен</b> - требования для сдачи на пояса

<u>Как искать:</u>
• Напишите точное название туля (например, "Чон-Джи")
• Напишите цвет пояса (например, "желтый пояс")
• Укажите номер пояса (например, "5 гып")
• Для черных поясов: "1 дан", "черный пояс", "black belt"

<u>Команды:</u>
/start - Начало работы
/menu - Главное меню
/tuls - Все тули
/belts - Система поясов
/techniques - Техники тхэквондо
/exams - Экзамены на пояса
/help - Эта справка

<i>Удачи в изучении тхэквондо! 🥋</i>
        """

        await query.edit_message_text(
            help_text,
            reply_markup=self.get_back_menu(),
            parse_mode='HTML'
        )

    async def menu_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Команда /menu"""
        await update.message.reply_text(
            "🥋 <b>Главное меню</b>\n\nВыберите раздел:",
            reply_markup=self.get_main_menu(),
            parse_mode='HTML'
        )

    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Команда /help"""
        help_text = """
<b>Доступные команды:</b>

/start - Начало работы с ботом
/menu - Показать главное меню
/tuls - Показать все тули
/belts - Показать систему поясов
/techniques - Показать техники тхэквондо
/exams - Показать требования к экзаменам
/help - Показать эту справку

<b>Как использовать:</b>
• Используйте кнопки в меню для навигации
• Пишите название туля для получения информации
• Пишите цвет или номер пояса для поиска информации о нем

<i>Бот содержит полную информацию о 24 тулях тхэквондо ИТФ и требованиях к экзаменам!</i>
        """

        await update.message.reply_text(
            help_text,
            reply_markup=self.get_main_menu(),
            parse_mode='HTML'
        )

    async def tuls_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Команда /tuls - список всех тулей"""
        stats = self.knowledge.knowledge_base["statistics"]

        await update.message.reply_text(
            f"🌀 <b>Все тули тхэквондо ИТФ</b>\n\n"
            f"Всего тулей: {stats['total_tuls']}\n"
            f"Всего движений: {stats['total_movements']}\n\n"
            "Выберите уровень пояса:",
            reply_markup=self.get_tuls_menu(),
            parse_mode='HTML'
        )

    async def belts_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Команда /belts - система поясов"""
        await update.message.reply_text(
            "🎽 <b>Система поясов тхэквондо ИТФ</b>\n\n"
            "10 ученических степеней (гыпов) и 9 мастерских (данов).\n\n"
            "Выберите уровень:",
            reply_markup=self.get_belts_menu(),
            parse_mode='HTML'
        )

    async def techniques_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Команда /techniques - техники тхэквондо"""
        await update.message.reply_text(
            "📚 <b>Техники тхэквондо ИТФ</b>\n\n"
            "Выберите категорию техник:",
            reply_markup=self.get_techniques_menu(),
            parse_mode='HTML'
        )

    async def exams_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Команда /exams - экзамены"""
        await update.message.reply_text(
            "📋 <b>Экзамены на пояса</b>\n\n"
            "Выберите пояс для просмотра требований к экзамену:",
            reply_markup=self.get_exams_menu(),
            parse_mode='HTML'
        )

    async def error_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Обработчик ошибок"""
        logger.error(f"Ошибка: {context.error}", exc_info=context.error)

        if update and update.effective_message:
            try:
                await update.effective_message.reply_text(
                    "⚠️ Произошла ошибка. Пожалуйста, попробуйте позже.",
                    reply_markup=self.get_main_menu()
                )
            except:
                pass


def main():
    """Запуск бота"""
    try:
        bot = TaekwondoTulBot()

        app = Application.builder().token(bot.TOKEN).build()

        # Регистрация обработчиков команд
        app.add_handler(CommandHandler("start", bot.start_command))
        app.add_handler(CommandHandler("menu", bot.menu_command))
        app.add_handler(CommandHandler("help", bot.help_command))
        app.add_handler(CommandHandler("tuls", bot.tuls_command))
        app.add_handler(CommandHandler("belts", bot.belts_command))
        app.add_handler(CommandHandler("techniques", bot.techniques_command))
        app.add_handler(CommandHandler("exams", bot.exams_command))

        # Регистрация обработчиков сообщений
        app.add_handler(CallbackQueryHandler(bot.handle_callback))
        app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, bot.handle_message))

        # Обработчик ошибок
        app.add_error_handler(bot.error_handler)

        print("=" * 70)
        print("🌀 БОТ-ЭНЦИКЛОПЕДИЯ ТУЛЕЙ ТХЭКВОНДО ИТФ ЗАПУЩЕН!")
        print(f"📚 Загружено тулей: {len(bot.knowledge.tuls)}")
        print(f"🎽 Уровней поясов: {len(bot.knowledge.belts)}")
        print(f"📋 Экзаменов: {len(bot.knowledge.exams)}")
        print("📚 Категорий техник: 6")
        print("🔍 Улучшенный поиск по поясам: ДА")
        print("🥋 Поиск по данам: ДА")
        print("💾 Все данные сохранены локально")
        print("=" * 70)
        print("\n📱 Бот готов к работе! Откройте Telegram и найдите бота.")
        print("💡 Используйте команду /start в Telegram для начала работы")
        print("📋 Новая команда: /exams - требования к экзаменам на пояса")
        print("📚 Новая команда: /techniques - техники тхэквондо")

        app.run_polling(drop_pending_updates=True)

    except ValueError as e:
        print(f"❌ ОШИБКА: {e}")
        print("\nДля запуска бота необходимо:")
        print("1. Создать файл .env в той же папке")
        print("2. Добавить в него строку:")
        print("   TELEGRAM_BOT_TOKEN=ваш_токен_бота")
        print("3. Получить токен у @BotFather в Telegram")
    except Exception as e:
        print(f"❌ Критическая ошибка: {e}")


if __name__ == "__main__":
    main()
